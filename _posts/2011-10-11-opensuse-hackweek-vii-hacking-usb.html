---
layout: post
title: OpenSUSE Hackweek VII - Hacking USB Joysticks in YaST
date: '2011-10-11T03:57:00.000-07:00'
author: Ladislav Slez√°k
tags:
- yast hwinfo usb gameport joystick
modified_time: '2011-10-11T05:20:07.296-07:00'
thumbnail: http://3.bp.blogspot.com/-PfM1ymwGhKE/TpQDao-sakI/AAAAAAAAABY/H_uumPY-62I/s72-c/YaST_joystick_old1.png
blogger_id: tag:blogger.com,1999:blog-6535501136403374362.post-4020151796715603823
blogger_orig_url: http://lslezak.blogspot.com/2011/10/opensuse-hackweek-vii-hacking-usb.html
---

<br /><span style="font-size: large;">Introduction</span><br /><br />This <a href="http://en.opensuse.org/Portal:Hackweek">hackweek</a> I spent playing with joysticks in <a href="http://en.opensuse.org/Portal:YaST">YaST</a> and hwinfo (libhd).<br />YaST already has a module for configuring joysticks, but I only supported <a href="http://en.wikipedia.org/wiki/Gameport">Gameport</a> joysticks which are quite obsoleted these days.<br /><br />AFAIK all recent mainboards do not have gamport connectors (just a pin header) or the gameport is completely missing. And if you want to buy a joystick you will find only USB models anyway.<br /><br />There was a note in the YaST module that it only supports Gameport joysticks but some users find it confusing.<br /><br />So I decided to change the situation and do something interesting during my Hackweek project - to add USB joystick support to YaST.<br /><br /><span style="font-size: large;">Hacking</span><br /><br />The support in YaST actually has three parts. YaST uses libhd (from <a href="https://gitorious.org/opensuse/hwinfo">hwinfo</a> package) for hardware detection, than there is yast2-hardware-detection package which is a libhd wrapper converting C functions and data to YCP (the main YaST language) and finally there is yast2-sound package which contains the joystick configuration module.<br /><br />The first step was to add USB joystick support to hwinfo so it could be used for joystick detection. The problem was that hwinfo found the USB joystick device but it didn't know that it's a joystick and reported it as an unclassified generic USB device and also the joystick result was empty:<br /><br /><br /><pre style="background-color: black; color: white; padding: 3px;"># hwinfo --usb<br /><i>[...removed not relevant info...]</i><br />12: USB 00.0: 0000 <b>Unclassified device</b><br />  [Created at usb.122]<br />  Unique ID: JPTW.MyFI+3nAFw7<br />  Parent ID: FKGF.4Nx_qoDfSd7<br />  SysFS ID: /devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.3/2-1.3:1.0<br />  SysFS BusID: 2-1.3:1.0<br />  Hardware Class: <b>unknown</b><br />  Model: "KYE Flight2000 F-23 Joystick"<br />  Hotplug: USB<br />  Vendor: usb 0x0458 "KYE Systems"<br />  Device: usb 0x1004 "Flight2000 F-23 Joystick"<br />  Revision: "1.02"<br />  Driver: "usbhid"<br />  Driver Modules: "usbhid"<br />  Device File: /dev/input/event5<br />  Device Files: /dev/input/event5, /dev/input/by-id/usb-0458_4-axis_8-button_joystick-event-joystick, /dev/input/by-path/pci-0000:00:1d.0-usb-0:1.3:1.0-event-joystick<br />  Device Number: char 13:69<br />  Speed: 1.5 Mbps<br />  Module Alias: "usb:v0458p1004d0102dc00dsc00dp00ic03isc00ip00"<br />  Config Status: cfg=no, avail=yes, need=no, active=unknown<br />  Attached to: #8 (Hub)<br /># hwinfo --joystick<br />#<br /><br /></pre><br />So the detection code was there, it just needed small improvement. This was rather easy.<br />Then I checked also <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hwinfo --joystick</span> output, it was fine.<br /><br />Then I put an old low-end sound (Sound Blaster 128 PCI) with gameport into my PC and connected an old analog joystick. The old YaST joystick module worked fine I and I configured it.<br /><br />Then I checked&nbsp; <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hwinfo --joystick</span> output again and the analog joystick was not found. It turned out that the hwinfo code actually could never detect any joystick. So I also added Gameport support and fixed Gameport joystick detection.<br /><br />So at this point I had working joystick detection, but I wanted to improve it a little bit. I wanted detect and report some joystick properties, like number of buttons and axes it has. This turned out to be similar to mouse button detection which already worked fine. So again not a big problem.<br /><br />The detection part was ready, then I just added&nbsp; passing joystick details into the yast2-hardware-detection layer so it could be used from YaST.<br /><br />The most complicated part was the YaST joystick module itself because it supported only gameport joystick and USB joysticks could not be simply added to the UI and also the internal structure had to be completely rewritten.<br /><br /><br /><span style="font-size: large;">The Outcome</span><br /><br />So what has been changed?<br /><br />The&nbsp; <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hwinfo --joystick</span> output will contain all detected joysticks (both USB and Gameport): <br /><br /><pre style="background-color: black; color: white; padding: 3px;"># hwinfo --joystick <br />24: USB 00.0: 10d00 <b>Joystick</b><br />  [Created at usb.122]<br />  Unique ID: o2Ga.iGyiCvRqXrA<br />  Parent ID: FKGF.4Nx_qoDfSd7<br />  SysFS ID: /devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.7/2-1.7:1.0<br />  SysFS BusID: 2-1.7:1.0<br />  Hardware Class: <b>joystick</b><br />  Model: "KYE Flight2000 F-23 Joystick"<br />  Hotplug: USB<br />  Vendor: usb 0x0458 "KYE Systems"<br />  Device: usb 0x1004 "Flight2000 F-23 Joystick"<br />  Revision: "1.02"<br />  Driver: "usbhid"<br />  Driver Modules: "usbhid"<br />  Device File: /dev/input/event6 <b>(/dev/input/js1)</b><br />  Device Files: /dev/input/event6, <b>/dev/input/js1</b>, /dev/input/by-id/usb-0458_4-axis_8-button_joystick-event-joystick, /dev/input/by-path/pci-0000:00:1d.0-usb-0:1.7:1.0-event-joystick, /dev/input/by-id/usb-0458_4-axis_8-button_joystick-joystick, /dev/input/by-path/pci-0000:00:1d.0-usb-0:1.7:1.0-joystick<br />  Device Number: char 13:70<br />  Speed: 1.5 Mbps<br />  Module Alias: "usb:v0458p1004d0102dc00dsc00dp00ic03isc00ip00"<br />  <b>Buttons: 8</b><br />  <b>Axes: 6</b><br />  Config Status: cfg=no, avail=yes, need=no, active=unknown<br />  Attached to: #20 (Hub)<br /><br />25: <b>Gameport</b> 00.0: 10d00 <b>Joystick</b><br />  [Created at input.316]<br />  Unique ID: pJ6W.6RgETWGhHg1<br />  Parent ID: i_aO.F2uWXyTiEa3<br />  SysFS ID: /pci0000:00/0000:00:1e.0/0000:04:02.0/gameport0/input/input58<br />  Hardware Class: <b>joystick</b><br />  Model: "Analog 4-axis 4-button joystick"<br />  Vendor: 0x0001 <br />  Device: 0x000f "Analog 4-axis 4-button joystick"<br />  Device File: /dev/input/event5 <b>(/dev/input/js0)</b><br />  Device Files: /dev/input/event5, <b>/dev/input/js0</b>, /dev/input/by-path/pci-0000:04:02.0-event-joystick, /dev/input/by-path/pci-0000:04:02.0-joystick<br />  Device Number: char 13:69<br />  <b>Buttons: 4</b><br />  <b>Axes: 4</b><br />  Config Status: cfg=no, avail=yes, need=no, active=unknown<br />  <b>Attached to: #16 (Multimedia audio controller)</b><br /><br /></pre><br />The changes are highlighted: it correctly finds the joystick, reports number of axes and buttons, /dev/input/jsX device name is reported, game port joystick is found and for game port joysticks it reports also the sound card to which it is attached to.<br /><br />The changes in the YaST module are best described by the following screen shots. Let's start with the old YaST module:<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-PfM1ymwGhKE/TpQDao-sakI/AAAAAAAAABY/H_uumPY-62I/s1600/YaST_joystick_old1.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="151" src="http://3.bp.blogspot.com/-PfM1ymwGhKE/TpQDao-sakI/AAAAAAAAABY/H_uumPY-62I/s200/YaST_joystick_old1.png" width="200" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">The old YaST module with one configured Gameport joystick</td></tr></tbody></table><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: 1em; margin-right: 1em; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-5-0_QCFkskA/TpQDbTdSvbI/AAAAAAAAABo/LtvYWykRecs/s1600/YaST_joystick_old3.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="91" src="http://2.bp.blogspot.com/-5-0_QCFkskA/TpQDbTdSvbI/AAAAAAAAABo/LtvYWykRecs/s200/YaST_joystick_old3.png" width="200" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">When the computer doesn't have any game port the old module displayed just this message although an USB joystick could be attached.</td></tr></tbody></table><br /><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-h0CcCPHJ3xY/TpQDax7VqJI/AAAAAAAAABg/8YP_VE3_ppk/s1600/YaST_joystick_old2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="178" src="http://3.bp.blogspot.com/-h0CcCPHJ3xY/TpQDax7VqJI/AAAAAAAAABg/8YP_VE3_ppk/s200/YaST_joystick_old2.png" width="200" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Old joystick test dialog, notice the wrong number of buttons and axes, also using progress bars is not appropriate for this dialog</td></tr></tbody></table><br /><br />Here is the new updated YaST module:<br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-PZgqn39NTF4/TpQDy1lUbgI/AAAAAAAAABw/EadgYXD7-xs/s1600/YaST_joystick_new3.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="118" src="http://3.bp.blogspot.com/-PZgqn39NTF4/TpQDy1lUbgI/AAAAAAAAABw/EadgYXD7-xs/s200/YaST_joystick_new3.png" width="200" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Both USB and Gameport joysticks are displayed with more details </td></tr></tbody></table><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-VPzNx9LMU0k/TpQDaA9F9AI/AAAAAAAAABQ/k-jrKbPU7DQ/s1600/YaST_joystick_new2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="159" src="http://2.bp.blogspot.com/-VPzNx9LMU0k/TpQDaA9F9AI/AAAAAAAAABQ/k-jrKbPU7DQ/s200/YaST_joystick_new2.png" width="200" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">The testing dialog has been improved - button and axes detection is correct, sliders are used instead of progress bars and also the joystick name is displayed (usefull when there are more joysticks attached).</td></tr></tbody></table><br /><div class="separator" style="clear: both; text-align: center;"></div>&nbsp;This is quite a nice change, isn't it?<br /><br />As a bonus I have added hotplug handling into the joystick module - if you plug or unplug any USB joystick the table get refreshed. AFAIK that is unique feature among all YaST modules...<br /><br />All these changes have been submitted to&nbsp; Factory/12.1 and should be available in 12.1-RC1 when released. <br /><br /><br />