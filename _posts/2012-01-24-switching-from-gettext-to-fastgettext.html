---
layout: post
title: Switching from Gettext to FastGettext in a Rails3 app
date: '2012-01-24T02:13:00.000-08:00'
author: Ladislav Slez√°k
tags: 
modified_time: '2012-01-24T02:13:31.353-08:00'
blogger_id: tag:blogger.com,1999:blog-6535501136403374362.post-8679252270558627951
blogger_orig_url: http://lslezak.blogspot.com/2012/01/switching-from-gettext-to-fastgettext.html
---

<h1>From Gettext to FastGettext</h1> In <a href="http://www.suse.com/products/susestudio/features/lifecycle-management.html">SLMS</a> we use Gettext for i18n support. Unfortunately it doesn't work with new Rails 3. But we found out that there is <a href="https://github.com/grosser/fast_gettext">FastGettext</a> Ruby gem which does work with Rails 3 and we decided to switch to this different implementation.<br /><br /> In this blogpost I'll describe the needed steps when switching from Gettext to FastGettext. And here also are solutions for some problems we found during the transition.<br />  <h1>Using the new Ruby gems</h1> You will need these new Ruby gems: <ul>  <li>fast_gettext: <a href="https://github.com/grosser/fast_gettext">https://github.com/grosser/fast_gettext</a></li>  <li>gettext_i18n_rails: <a href="https://github.com/grosser/gettext_i18n_rails">https://github.com/grosser/gettext_i18n_rails</a> <i>(FastGettext Rails integration)</i></li>  <li>rails-i18n: <a href="https://github.com/svenfuchs/rails-i18n">https://github.com/svenfuchs/rails-i18n</a> <i>(Default Rails translations)</i></li></ul> <br /> The first step is to remove the old Gettext gems and replace them by FastGettext gems.<br />So replace these gems in your Gemfile:<br /><br /><div class="code_example"><pre class="brush: ruby">gem 'locale'<br />gem 'locale_rails'<br />gem 'gettext'<br />gem 'gettext_activerecord'<br />gem 'gettext_rails'</pre></div>by:  <br /><div class="code_example"><pre class="brush: ruby">gem 'fast_gettext'<br /><br /># 0.4.3 contains fixes in<br />#'rake gettext:store_model_attributes' task<br />gem 'gettext_i18n_rails', '&gt;= 0.4.3'<br /><br /># rails-i18n provides translations for ActiveRecord<br /># validation error messages<br />gem 'rails-i18n'<br /><br /># needed to collect translatable strings<br /># not needed at production<br />group :development do<br />  # needed for HAML support (optional)<br />  gem 'ruby_parser'<br /><br />  # no need to load the gem via require<br />  # we only need the rake tasks<br />  gem 'gettext', '&gt;= 1.9.3', :require =&gt; false<br />end<br /></pre></div><br />Then you need to initialize FastGettext, create <tt>config/initializers/fast_gettext.rb</tt> file:  <br /><div class="code_example"><pre class="brush: ruby"># define your text domain<br />FastGettext.add_text_domain 'foo', :path =&gt; File.join(File.dirname(__FILE__), '..', '..', 'locale')<br /><br /><br /># set the default textdomain<br />FastGettext.default_text_domain = 'foo'<br /><br /># set available locales<br /># (note: the first one is used as a fallback if you try to set an unavailable locale)<br />FastGettext.default_available_locales = ["en_US","ar","cs","de","es",...]<br /></pre></div>Replace <i>foo</i> with your textdomain.  Now you need to add FastGettext initialization in your application controller:  <br /><div class="code_example"><pre class="brush: ruby">class ApplicationController &lt; ActionController::Base<br />  # replace these old Gettext calls:<br />  #   init_gettext "your_domain"<br />  #   GetText.textdomain("your_domain")<br />  # by this:<br />  include FastGettext::Translation<br /><br />  before_filter :set_users_locale <br /><br />  def set_users_locale<br />    I18n.locale = FastGettext.set_locale(params[:locale] || cookies[:locale] ||<br />      request.env['HTTP_ACCEPT_LANGUAGE'] || 'en_US')<br />    cookies[:locale] = I18n.locale if cookies[:locale] != I18n.locale.to_s<br />  end<br />end&nbsp;</pre></div>The set_users_locale before filter handles setting the correct locale for every request. The locale is set via a cookie and can be changed using ?locale=<i>locale</i> URL option. It is possible to use different solution for switching the locale, e.g. as path prefix aor domain name - see <a href="http://guides.rubyonrails.org/i18n.html">the Rails guide</a><br /><br /><b>Note:</b> The application needs to be restarted after any change in the translations.<br /><h1>Solved Problems</h1><h2>Automatic detection of available locales</h2> Using fixed list in the available locales list might not be nice, especially if you want to dynamically add new translations later. In this case you need to find the available locales dynamically at start. The solution si to put this code to <tt>config/initializers/fast_gettext.rb</tt> file:  <div class="code_example"><pre class="brush: ruby"># put 'en_US' as first, the first item is used as a fallback<br /># when requested locale (via ?locale= URL parameter) is not found<br />FastGettext.default_available_locales = ["en_US"]<br /><br /># get available locales automatically<br />Dir[File.join(File.dirname(__FILE__), '..', '..', 'locale', "/*/LC_MESSAGES/*.mo")].each do |l|<br />  if l.match(/\/([^\/]+)\/LC_MESSAGES\/.*\.mo$/) &amp;&amp; !FastGettext.default_available_locales.include?($1)<br />    FastGettext.default_available_locales &lt;&lt; $1<br />  end<br />end<br /></pre></div><h2> Language and Country Separator in locale name</h2> Rails native localization support uses I18n module for translation support. The problem is that it uses dash (-) separator between langugage and country code in locale names.<br/><br/>This makes a problem when using with standard gettext locale schema which uses underscore (_) as the separator. For example translations from rails-i18n gem will not be found when the current locale in en_US, it expects en-US locale.<br/><br/>The problem can be solved by defining locale fallbacks like this (put this to <tt>config/initializers/fast_gettext.rb</tt> file):  <br /><div class="code_example"><pre class="brush: ruby"># enable fallback handling<br />I18n::Backend::Simple.include(I18n::Backend::Fallbacks)<br /><br /># set some locale fallbacks needed for ActiveRecord translations<br /># located in rails_i18n gem (e.g. there is en-US.yml translation)<br />I18n.fallbacks[:"en_US"] = [:"en-US", :en]<br />I18n.fallbacks[:"en_GB"] = [:"en-GB", :en]<br />I18n.fallbacks[:"pt_BR"] = [:"pt-BR", :pt]<br />I18n.fallbacks[:"zh_CN"] = [:"zh-CN"]<br />I18n.fallbacks[:"zh_TW"] = [:"zh-TW"]<br />I18n.fallbacks[:"sv"] = [:"sv-SE"]<br /></pre></div>This means that if for example a translation for <i>en_US</i> locale is not found then <i>en-US</i> will be tried and then <i>en</i> locale.  <br /><h2>Including source file name and line number is the final POT file</h2>By default when you run 'rake gettext:find' task to collect the translatable string the output will not contain  the source file name and the line number. It's very useful if you get a feedback from translator (like a typo in the original message) then you don't have to scan all file but you immediately know where to fix the problem.<br /><br />If you want to change this behavior and include the line numbers add this configuration to <tt>config/initializers/fast_gettext.rb</tt> file:<br /><div class="code_example"><pre class="brush: ruby"># configure default msgmerge parameters (the default contains "--no-location" option<br /># which removes code lines from the final POT file)<br />Rails.application.config.gettext_i18n_rails.msgmerge = ["--sort-output", "--no-wrap"]<br /></pre></div><h2>Sorting messsages in the final POT file</h2>The 'rake gettext:find' task sorts the messages in the final POT file alphabetically. The advantage is that if you add a new string and regenerate the file then the files will be similar and the diff will be small.<br /><br />The problem is that the sorting is done at the merge step, when merging the new found translation wit the old ones. At the very first run (when the final POT file does not exist yet) the merge step is skipped and thus the messages are not sorted. This can be fixed by starting the task once more (the second run will find existing messages and do the merge with sorting).<br /><br />But the problem is that you can easily forget to run the task for the second run. The workaround is to create an empty target POT file when the it doesn't exist yet. Unfortunately simple <tt>touch</tt> command is not sufficient (msgmerge failed for me with some strange UTF-8 error), we have to create valid POT but without any messages.<br /><br />The workaround it to put this code to <tt>lib/tasks/gettext.rake</tt> file: <div class="code_example"><pre class="brush: ruby"># 'gettext:find' sorts the messages alphabetically only when it is merging existing messages<br /># copying empty pot file from the template forces sorting even at the first run<br />namespace :gettext do<br />  task :create_pot_template do<br />    FileUtils.cp("locale/template.pot", "locale/textdomain.pot") unless File.exists?("locale/textdomain.pot")<br />  end<br />end<br /><br /># add task dependency<br />task :'gettext:find' =&gt; :'gettext:create_pot_template'<br /></pre></div>The <tt>locale/textdomain.pot</tt> template should look like this:<br /><div class="code_example"><pre class="brush: ruby"># SOME DESCRIPTIVE TITLE.<br /># Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER<br /># This file is distributed under the same license as the PACKAGE package.<br /># FIRST AUTHOR &lt;email@address&gt;, YEAR.<br />#<br />#, fuzzy<br />msgid ""<br />msgstr ""<br />"Project-Id-Version: version 0.0.1\n"<br />"POT-Creation-Date: 2012-01-16 17:56+0100\n"<br />"PO-Revision-Date: 2012-01-16 17:56+0100\n"<br />"Last-Translator: FULL NAME &lt;email@address&gt;\n"<br />"Language-Team: LANGUAGE &lt;ll@li.org&gt;\n"<br />"MIME-Version: 1.0\n"<br />"Content-Type: text/plain; charset=UTF-8\n"<br />"Content-Transfer-Encoding: 8bit\n"<br />"Plural-Forms: nplurals=INTEGER; plural=EXPRESSION;\n"<br /></pre></div> <h2>Automatic translation in HAML files</h2> It is possible to extend HAML parser to automatically translate all plain text strings. The advantage is than you don't have to explicitly use _() function and you cannot forget to mark a text to translation.<br /><br />This can be done using <a href="http://pastie.org/445295">this code snippet</a>. Save it to a file, remove the require calls at the beginning (they are obsoleted and do not work with new gettext) and require it in your ApplicationController.<br /><br />Then you need to add support to 'rake gettext:find' task. Save <a href="http://pastie.org/445297">this code snippet</a> to <tt>lib/haml_parser.rb</tt> file. You need to replace <tt>require 'gettext/parser/ruby'</tt> by <tt>require 'gettext/tools/parser/ruby'</tt> so it works with newer gettext gem.<br /><br />Then put this to <tt>lib/tasks/gettext.rake</tt> file:  <div class="code_example"><pre class="brush: ruby"># extend the HAML parser to extract plain text messages<br /># to support automatic translations (without need to mark the text with _())<br />namespace :gettext do<br />  task :haml_parser do<br />    require 'haml_parser'<br />  end<br />end<br /><br /># extend the HAML parser before collecting the translatable texts<br />task :'gettext:find' =&gt; :'gettext:haml_parser'<br /></pre></div>