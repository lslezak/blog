---
layout: post
title: 'SUSE HackWeek12 - YaST: Replacing Travis by Jenkins'
date: '2015-04-27T08:22:00.001-07:00'
author: Ladislav Slez√°k
tags:
- CI
- Jenkins
- yast
- continuous integration
- Travis
modified_time: '2015-04-27T08:22:21.141-07:00'
thumbnail: http://3.bp.blogspot.com/-NwAINs2_ZF8/VTUNNIN0VcI/AAAAAAAANkI/xPmeuEtB3pk/s72-c/jenkins_rubymetrics1.png
blogger_id: tag:blogger.com,1999:blog-6535501136403374362.post-8349652029406982885
blogger_orig_url: http://lslezak.blogspot.com/2015/04/suse-hackweek12-yast-replacing-travis.html
---

<h2>Replacing Travis by Jenkins for YaST</h2><br />I decided to look at the possible Travis replacement as my Hackweek 12 project.<br /><br />Currently we use both&nbsp;<a href="https://travis-ci.org/">Travis</a>&nbsp;and <a href="https://ci.opensuse.org/view/Yast/" target="_blank">Jenkins</a> for continuous integration in YaST projects. Unfortunately there are many disadvantages with Travis which require additional work or limit us what we can run in a Travis job. See <a href="https://hackweek.suse.com/projects/888" target="_blank">the hackweek project</a> for the pros and cons summary.<br /><div><br /></div><div>The biggest Travis disadvantage is that the builds are run in a Ubuntu 12.04 system which is 3 years old and it's very difficult to find a recent compiler, Ruby interpreter, libraries,... for it.&nbsp;</div><div><br /></div><div>The Jenkins advantage is that it runs on our server and we can run the latest openSUSE very easily and avoid the problem with porting YaST packages to Ubuntu and backporting the development tools.</div><div><br /></div><div><h4>Jenkins Plugins</h4><div><br /></div>I found out that there are several Jenkins plugins which could be used to replace Travis with Jenkins:</div><div><ul><li>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/Github+Plugin">GitHub plugin</a> - handlers commit hooks sent by GitHub, reports build status back</li><li>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/GitHub+pull+request+builder+plugin">GitHub Pull Request Builder</a> - handles pull request hooks sent by GitHub (similar to the previous plugin, but builds the merged result)</li><li>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/Embeddable+Build+Status+Plugin">Embeddable build status plugin</a> - provides a build status badge (similar to Travis one)</li></ul><div><br /></div>You can install the plugins in your Jenkins instance like this:<br /><ul><li>Login into Jenkins</li><li>Go to <i>Manage Jenkins</i> -&gt;&nbsp;<i>Manage Plugins</i></li><li>In the tab <i>Available</i>&nbsp;select plugins&nbsp;<i>GitHub Plugin</i>, <i>GitHub pull request builder plugin</i> and <i>Embeddable Build Status Plugin</i>&nbsp;and install them</li></ul></div><div><h3></h3><h3>Configuring the GitHub Plugin</h3><ul><li><a href="https://github.com/settings/tokens/new" target="_blank">Generate a new access token at GitHub</a>, select <i>public_repo</i> and <i>repo:status</i>. If you want to allow automatic webhook setup select <i>write:repo_hook</i>&nbsp;(you can add/remove the permissions later).</li><li>Add the token to Jenkins -&gt;&nbsp;<i>Manage Jenkins</i> -&gt;&nbsp;<i>Configure System</i> -&gt;&nbsp;<i>GitHub Web Hook</i>&nbsp;section -&gt;&nbsp;<i>OAuth token</i>&nbsp;field</li><li>Put the same token to the "GitHub Pull Request Builder" section, "Access Token" filed.</li></ul><h4>Create a new Jenkins job for building commits (pull requests are handled separately):</h4><ul><li>Select <i>Freestyle project</i></li><li>Put the Github URL (https://github.com/<user>/<repo>) to the <i>GitHub project</i>&nbsp;filed</repo></user></li><li>In the <i>Source Code Management</i>&nbsp;section select Git and put the same URL here</li><li>Make <i>Branch Specifier</i>&nbsp;field empty to build all branches</li><li>In the <i>Build Triggers</i> section - check <i>Build when a change is pushed to GitHub</i></li><li>Add Build Step -&gt;&nbsp;select Set build status to "pending" on GitHub commit</li><li>Add post-build action - Set build status on GitHub commit</li><li>Configure the other parameters of the build as needed</li></ul>See more details <a href="https://wiki.jenkins-ci.org/display/JENKINS/GitHub+Plugin">here</a>.<br /><br /><h3>Configuring the GitHub Pull Request Builder</h3><div><ul><li>Add the created GitHub token to Jenkins -&gt; <i>Manage Jenkins</i> -&gt; <i>Configure System</i> -&gt; <i>GitHub Pull Request Builder</i>&nbsp;section</li></ul><h4>Create a new job for building pull requests:</h4><ul><li>Select <i>Free style project</i></li><li>Put the Github URL (https://github.com/<user>/<repo>) to the&nbsp;<i>GitHub project</i>&nbsp;filed</repo></user></li><li>In the&nbsp;<i>Source Code Management</i>&nbsp;section select Git and put the same URL here</li><li>In <i>Advanced</i>&nbsp;option set <i>Name</i> to <b>origin</b> and&nbsp;<i>Refspec</i>&nbsp;to&nbsp;<b>+refs/pull/*:refs/remotes/origin/pr/*</b></li><li>Set <i>Branch Specifier</i> to <b>${sha1}</b></li><li>In the&nbsp;<i>Build Triggers</i> section - check <i>GitHub Pull Request Builder</i> option</li><li>Check <i>Use github hooks for build triggering</i> option</li><li>Set <i>Commit Status Context</i> to <b>continuous-integration/jenkins-ci/pr</b> (or something like that to have a different ID for pull requests and avoid clashing with the GitHub plugin configured in the previous step</li></ul>Set Admins or white list users so you do not have to manually trigger builds for trusted developers - the plugin avoids running trusted code at your</div><div><br /></div><h3>Using Both Plugins in One Job?</h3><div><br /></div><div>I tried to use both plugins in a single job to have less jobs but it did not work form me, the pull requests were not processed at all or it did not work at all.</div><div><br /></div><div>If you find how to solve it let me know...</div><h3></h3><h3><br /></h3><h3>Coveralls Support?</h3><br />The question was whether&nbsp;<a href="https://coveralls.io/" target="_blank">coveralls</a>&nbsp;code coverage can run also outside the Travis environment.<br /><br />I found out that it is possible, you just need to set the&nbsp;<span style="font-family: Courier New, Courier, monospace;">COVERALLS_REPO_TOKEN</span>&nbsp;environment variable and some other variables containing the Git branch, build number, etc... See more details <a href="https://coveralls.zendesk.com/hc/en-us/articles/201347419-Coveralls-currently-supports" target="_blank">here</a>.<br /><br />You need to store the token into Jenkins and set it during build. &nbsp;(You can put the token directly into the&nbsp;<i>.coveralls.yml</i> file, but that's not a good idea for a public Git repository...) Fortunately there is a Jenkins plugin which helps with this, it can inject a secret in to a environment variable. The nice feature is that it can also filter the console output to make sure your password/token does not leak in the build output.<br /><br /><br /><h2>The Current State</h2><br />I have created some experimental jobs to try the plugins, e.g. <a href="https://ci.opensuse.org/view/Yast/job/yast-registration-github-ci/" target="_blank">yast-registration-github-ci</a>, <a href="https://ci.opensuse.org/view/Yast/job/yast-devtools-github-ci/" target="_blank">yast-devtools-github-ci</a>&nbsp;or <a href="https://ci.opensuse.org/view/Yast/job/yast-journal-github-ci/" target="_blank">yast-journal-github-ci</a>.<br /><br />The jobs are not ready to fully replace the Travis integration, but they work and I my plan is to continue with this project later.<br /><br /><br /><h2>TODO?</h2><br />There are still many thing to solve:<br /><br /><div><ul><li>Coveralls - pass the Git data (branch name, etc.) from Jenkis, set the&nbsp;&nbsp;<span style="font-family: Courier New, Courier, monospace;">COVERALLS_REPO_TOKEN</span>&nbsp;variable, make sure it's not logged in the console to avoid compromising the value</li><li>Find a way how to define the scripts started in Jenkins. We need to replace the <i>.travis.yml</i> files with something equivalent and share the common parts effectively, very likely as a shared Rake task.</li><li>The current Jenkins jobs use active Git polling, we should switch that to use the GitHub web hooks&nbsp;</li></ul></div><div>So stay tuned, I'll post updates on this topic...<br /><br /></div><h2>Bonus Section</h2><div><br /></div><div>During the implementation I found some other interesting possibilities:</div><div><br /></div><div><br /></div><h3>Collecting Code Metrics and Code Coverage</h3><div><br /></div><div>The RubyMetrics Jenkins plugin can be used to collect Flog code metrics and RCov code coverage statistics:</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-NwAINs2_ZF8/VTUNNIN0VcI/AAAAAAAANkI/xPmeuEtB3pk/s1600/jenkins_rubymetrics1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-NwAINs2_ZF8/VTUNNIN0VcI/AAAAAAAANkI/xPmeuEtB3pk/s1600/jenkins_rubymetrics1.png" height="193" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-NKmO_acNtPc/VTUNNKkxuzI/AAAAAAAANkE/AbvkiSFNZkE/s1600/jenkins_rubymetrics2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-NKmO_acNtPc/VTUNNKkxuzI/AAAAAAAANkE/AbvkiSFNZkE/s1600/jenkins_rubymetrics2.png" height="302" width="320" /></a></div><div><br /></div><div>That looks nice, but the practical value is low. The code coverage can be collected by Coveralls, which can comment the changes in pull requests, and code quality can be scanned e.g. by CodeClimate which provides more details about the code and better evaluates the code quality in general. More over it offers some hint what and how to fix, not just plain numbers without any clue what's wrong with the code.<br /><br />So I decided to not use them for YaST.</div><br /><h3></h3><h3>Writing Jenkins Plugins in Ruby</h3><br />I found an interesting possibility when playing with Jenkins - it's possible to <a href="https://github.com/jenkinsci/jenkins.rb/wiki/Getting-Started-With-Ruby-Plugins" target="_blank">write a Jenkins plugins in Ruby</a>! There is also an <a href="https://github.com/masaki/jenkins-travis-yml-plugin" target="_blank">example</a>. Maybe we could simple enhance Jenkins if needed...<br /><br /></div>