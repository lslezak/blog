---
layout: post
title: Improved Disk Usage Estimation in YaST Installer
date: '2011-09-02T01:50:00.000-07:00'
author: Ladislav Slez√°k
tags:
- free space
- yast
- disk usage
modified_time: '2011-09-02T01:50:57.670-07:00'
blogger_id: tag:blogger.com,1999:blog-6535501136403374362.post-5271858326657108862
blogger_orig_url: http://lslezak.blogspot.com/2011/09/improved-disk-usage-estimation-in-yast.html
---

<span style="font-size: large;">Disk Usage</span><br /><br />YaST installer estimates used disk space in the final installed system. This is possible thanks to the disk usage metadata in installation repository (located in file <span style="font-size: x-small;"><span style="font-family: courier new;">suse/setup/descr/packages.DU.gz</span></span>).<br /><br />This file contains disk usage statistics for every package, so YaST needs just to sum them for all selected packages. (Actually it's slightly more complicated, the disk usage is stored per directory, so YaST/libzypp has to sum it up according to the proposed disk partitioning. Imagine you have separate /usr or /boot partition...)<br /><br /><span style="font-size: large;">The Problem</span><br /><br />This works well, but the problem is that the final sum does not match the real value you find after installation is completed.<br /><br />For example in openSUSE-12.1-M3 in default KDE installation the installer estimates this disk usage:<br /><br /><div style="padding-left: 1em;"><span style="font-size: x-small;">Free:  3.3GB<br />Used:  3.1GB<br />Total: 6.4GB</span></div><br />But if you install the system and check the real disk usage you will find these numbers:<br /><br /><pre style="background-color: black; color: white; padding: 3px;"># df -h /<br />Filesystem      Size  Used Avail Use% Mounted on<br />/dev/sda2       6,4G  3,7G  2,5G  61% /</pre><br /><span style="font-style: italic;">So the difference between estimated and real available free space is about 800MB! That's quite a lot!</span><br /><br />In this case it was not a problem, but if the target partition was smaller, YaST could tell that there would be e.g. 500MB free space but the installation would actually fail because of not enough free space. This problem was reported several times in Novell bugzilla, e.g. <a href="https://bugzilla.novell.com/show_bug.cgi?id=263275">bnc#263275</a>, <a href="https://bugzilla.novell.com/show_bug.cgi?id=495251">bnc#495251</a> and more.<br /><span style="font-size: large;"><br />Improvement</span><br /><br />So where is the extra space spent? Why it doesn't match? There are basically these reasons:<br /><br /><ul><li>Files not owned by any package - the repository metadata contains just disk usage for files owned by packages (the files which are in RPMs), it doesn't and cannot know anything about files which are created at runtime outside of RPM package files.<br /><br />The files are mainly (with usual size in default installation)<br /><ul><li>RPM database (contains info about the installed packages): 42MB</li><li>Zypp cache (contains info about the configured software repositories): 38MB</li><li>System logs: 14MB</li><li>Config backup files: 10MB</li><li>Kernel initrd: 10MB</li><li>... and many more small files, but they almost don't affect the overall size so they can be ignored</li></ul></li><li>File system fragmentation - space is allocated in blocks, so small files effectively take more space than their total size. (ReiserFS is an exception, it supports tail joining.)</li><li>File system's journal - modern file systems use journaling so the file system is in consistent state after system crash or power failure. On the other hand the journal takes some space, for example default Ext3/Ext4 journal size is 128MB (but it can be smaller, depending on partition size and block size). The journal decreases the usable free space.</li><li>Reserved space for root user - Ext file systems by default reserve 5% space for root user. RPM explicitly checks for non-root space (even if it is running as root and could actually use the space), the reserved space also decreases the usable free space.</li></ul><br /><span style="font-size: large;">Current State</span><br /><br />I have added all the above mentioned extra space into the YaST installer (except the FS fragmentation, that is hard to implement and would not significantly change the estimation.)<br /><br />The most difficult task was to figure out the default journal size depending the partition size. I had to look to the respective mkfs utility sources. Some options (like reserved space) might be also set in the YaST partitioner so the space calculation has to read and check the partitioning options.<br /><br />If you are interested in the implementation details the relevant commit can be found in <a href="http://lists.opensuse.org/yast-commit/2011-08/msg00377.html">http://lists.opensuse.org/yast-commit/2011-08/msg00377.html</a> <br /><br /><span style="font-size: large;">Result</span><br /><br />After patching the installer the estimated sizes (for the same installation) are:<br /><br /><div style="padding-left: 1em;"><span style="font-size: x-small;">Free: 2.6GB<br />Used: 3.8GB<br />Total: 6.4GB</span></div><br />This pretty matches the real disk usage mentioned above. It's not exactly the same, but it's a big improvement. And it actually will never be perfect as it will be always a guess (just more or less good).<br /><br />The improvement has been submitted to Factory and will be available in openSUSE-12.1-Beta.<br /><br /><span style="font-size: large;">To Do</span><br /><br /><span style="font-size: large;"><span style="font-size: small;">The only thing which is missing is Btrfs support.I'll have to check the mkfs.btrfs utility or Btrfs documentation. So far I have found out that after formatting 8GB partition using Btrfs <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">df</span> reports about 7.2GB free space. I have to found out how the final free space corresponds to the partition size. Moreover Btrfs supports transparent file compression, snapshots, etc. which also make the estimation more complicated...</span></span><br /><br /><span style="font-size: large;"><span style="font-size: small;">If you have any note on this feature just add a comment to this blog post. Thank you!</span> </span>